#+TITLE: jsec/ca - Certificate Authority Module
#+AUTHOR: jsec project
#+OPTIONS: toc:nil ^:nil

* Overview

The ~jsec/ca~ module provides a complete Certificate Authority (CA) implementation
for managing X.509 certificates. It supports:

- Root CA generation
- Intermediate CA generation
- Certificate issuance (from CSRs or direct generation)
- Certificate revocation and CRL generation
- OCSP response creation (mechanics only - you provide HTTP server)

** Design Philosophy

- *Simple API for common cases* - ~:issue~ generates key + cert in one call
- *Powerful API for complex cases* - ~:sign-csr~ gives full control
- *Methods AND functions* - Every operation works both ways
- *Stateless by default* - Tracking is opt-in for memory efficiency
- *Crypto only* - We handle certificates, you handle networking

* Quick Start

#+begin_src janet
(import jsec/ca)

# Generate a root CA
(def root-ca (ca/generate {:common-name "My Root CA"
                           :days-valid 3650}))

# Issue a server certificate
(def server (ca/issue root-ca {:common-name "server.example.com"
                               :san ["DNS:server.example.com"
                                     "DNS:localhost"
                                     "IP:127.0.0.1"]
                               :extended-key-usage "serverAuth"}))

# Use the certificate
(print (server :cert))  # PEM certificate
(print (server :key))   # PEM private key

# Get CA cert for trust stores
(print (:get-cert root-ca))
#+end_src

* API Reference

** Constructors

*** ~ca/generate~

Generate a new self-signed root CA.

#+begin_src janet
(ca/generate &opt opts)
#+end_src

Options:
| Option          | Default    | Description                             |
|-----------------+------------+-----------------------------------------|
| ~:common-name~  | "Root CA"  | CA common name                          |
| ~:days-valid~   | 3650       | Validity period in days                 |
| ~:key-type~     | ~:ec-p256~ | Key type (see Key Types below)          |
| ~:serial~       | 1          | Starting serial number for issued certs |
| ~:track-issued~ | false      | Track issued certificates in memory     |
| ~:organization~ | nil        | Organization name                       |
| ~:country~      | nil        | Two-letter country code                 |

*** ~ca/generate-intermediate~

Generate an intermediate CA signed by a parent CA.

#+begin_src janet
(ca/generate-intermediate parent-ca &opt opts)
#+end_src

Options are the same as ~ca/generate~ plus:
| Option         |           Default | Description                   |
|----------------+-------------------+-------------------------------|
| ~:path-length~ |                 0 | Maximum sub-CAs allowed       |
| ~:common-name~ | "Intermediate CA" | (different default)           |
| ~:days-valid~  |              1825 | (different default - 5 years) |

*** ~ca/create~

Create a CA from existing certificate and private key.

#+begin_src janet
(ca/create cert-pem key-pem &opt opts)
#+end_src

This is useful for:
- Loading a CA from files
- Restoring CA state from persistence

Options:
| Option          | Default | Description                          |
|-----------------+---------+--------------------------------------|
| ~:serial~       | 1       | Current serial number (restore this) |
| ~:track-issued~ | false   | Track issued certificates            |

** Certificate Issuance

*** ~:issue~ / ~ca/issue~

Generate a new certificate (key + cert in one step). This is the recommended
method for most use cases.

#+begin_src janet
(:issue ca &opt opts)
(ca/issue ca &opt opts)
#+end_src

Options:
| Option                | Required | Description                       |
|-----------------------+----------+-----------------------------------|
| ~:common-name~        | YES      | Certificate common name           |
| ~:san~                | no       | Subject Alternative Names (array) |
| ~:days-valid~         | no       | Validity period (default: 365)    |
| ~:key-type~           | no       | Key type (default: ~:ec-p256~)    |
| ~:key-usage~          | no       | Override key usage extension      |
| ~:extended-key-usage~ | no       | e.g., "serverAuth", "clientAuth"  |
| ~:organization~       | no       | Organization name                 |
| ~:country~            | no       | Country code                      |

Returns: ~{:cert <pem> :key <pem>}~

*** ~:sign-csr~ / ~ca/sign~

Sign a Certificate Signing Request (CSR). Use this when you need full control
over the certificate request process.

#+begin_src janet
(:sign-csr ca csr-pem &opt opts)
(ca/sign ca csr-pem &opt opts)
#+end_src

Options:
| Option                | Default           | Description                 |
|-----------------------+-------------------+-----------------------------|
| ~:days-valid~         | 365               | Validity period             |
| ~:serial~             | auto              | Override serial number      |
| ~:copy-extensions~    | false             | Copy extensions from CSR    |
| ~:key-usage~          | digitalSignature, | Key usage extension         |
|                       | keyEncipherment   |                             |
| ~:extended-key-usage~ | nil               | Extended key usage          |
| ~:san~                | nil               | Subject Alternative Names   |
| ~:basic-constraints~  | "CA:FALSE"        | Basic constraints extension |

Returns: Certificate in PEM format.

** Accessor Methods

*** ~:get-cert~ / ~ca/get-cert~

Get the CA's certificate in PEM format.

#+begin_src janet
(:get-cert ca)
(ca/get-cert ca)
#+end_src

*** ~:get-serial~ / ~ca/get-serial~

Get the CA's current serial number. Use for persistence.

#+begin_src janet
(:get-serial ca)
(ca/get-serial ca)
#+end_src

*** ~:set-serial~ / ~ca/set-serial~

Set the CA's serial number. Use to restore from persistence.

#+begin_src janet
(:set-serial ca serial)
(ca/set-serial ca serial)
#+end_src

*** ~:is-tracking~ / ~ca/is-tracking~

Check if the CA is tracking issued certificates.

#+begin_src janet
(:is-tracking ca)
(ca/is-tracking ca)
#+end_src

*** ~:get-issued~ / ~ca/get-issued~

Get list of issued certificates (only if tracking enabled).

#+begin_src janet
(:get-issued ca)
(ca/get-issued ca)
#+end_src

Returns: Array of PEM certificates, or nil if tracking disabled.

** Revocation and CRL

*** ~:revoke~ / ~ca/revoke~

Revoke a certificate by serial number.

#+begin_src janet
(:revoke ca serial &opt reason)
(ca/revoke ca serial &opt reason)
#+end_src

Revocation reasons:
| Keyword                   | Description                 |
|---------------------------+-----------------------------|
| ~:unspecified~            | Default                     |
| ~:key-compromise~         | Private key compromised     |
| ~:ca-compromise~          | CA key compromised          |
| ~:affiliation-changed~    | Subject affiliation changed |
| ~:superseded~             | Replaced by new certificate |
| ~:cessation-of-operation~ | No longer in use            |
| ~:certificate-hold~       | Temporarily suspended       |
| ~:remove-from-crl~        | Remove from CRL (unrevoke)  |
| ~:privilege-withdrawn~    | Privileges revoked          |
| ~:aa-compromise~          | AA key compromised          |

*** ~:generate-crl~ / ~ca/crl~

Generate a Certificate Revocation List.

#+begin_src janet
(:generate-crl ca &opt opts)
(ca/crl ca &opt opts)
#+end_src

Options:
| Option        | Default | Description                              |
|---------------+---------+------------------------------------------|
| ~:days-valid~ | 30      | CRL validity period                      |
| ~:revoked~    | nil     | Additional revocations (array of tables) |

Returns: CRL in PEM format.

*** ~:get-revoked~ / ~ca/get-revoked~

Get list of revoked certificate serials.

#+begin_src janet
(:get-revoked ca)
(ca/get-revoked ca)
#+end_src

Returns: Array of ~{:serial N :reason <kw>}~ tables.

** OCSP Support

The CA module provides OCSP *mechanics* only. You implement the HTTP server
yourself using Janet's networking or a web framework.

*** ~ca/parse-ocsp-request~

Parse an OCSP request (DER-encoded bytes).

#+begin_src janet
(ca/parse-ocsp-request request-bytes)
(:parse-ocsp-request ca request-bytes)  ; method form also works
#+end_src

Returns:
#+begin_src janet
{:issuer-name-hash <buffer>
 :issuer-key-hash <buffer>
 :serial <number>
 :nonce <buffer|nil>}
#+end_src

*** ~:create-ocsp-response~ / ~ca/create-ocsp-response~

Create an OCSP response for a certificate status query.

#+begin_src janet
(:create-ocsp-response ca request-info status &opt opts)
(ca/create-ocsp-response ca request-info status &opt opts)
#+end_src

| Argument       | Description                                 |
|----------------+---------------------------------------------|
| ~ca~           | The CA that issued the certificate          |
| ~request-info~ | Parsed request from ~ca/parse-ocsp-request~ |
| ~status~       | ~:good~, ~:revoked~, or ~:unknown~          |

Options:
| Option               | Description                                |
|----------------------+--------------------------------------------|
| ~:revocation-time~   | When revoked (required if status :revoked) |
| ~:revocation-reason~ | Why revoked (see revocation reasons)       |
| ~:this-update~       | Response validity start (default: now)     |
| ~:next-update~       | Response validity end (default: +1 day)    |
| ~:include-nonce~     | Echo nonce from request (default: true)    |

Returns: DER-encoded OCSP response bytes.

** OCSP Responder Example

#+begin_src janet
(import jsec/ca)

# Your CA
(def ca (ca/create (slurp "ca.crt") (slurp "ca.key")))

# Your certificate status lookup (implement based on your storage)
(defn lookup-status [serial]
  (if (revoked? serial)
    :revoked
    :good))

# OCSP handler for your HTTP server
(defn handle-ocsp [request]
  (def parsed (ca/parse-ocsp-request (request :body)))
  (def status (lookup-status (parsed :serial)))
  (def response (:create-ocsp-response ca parsed status))
  
  {:status 200
   :headers {"Content-Type" "application/ocsp-response"}
   :body response})
#+end_src

* Key Types

Supported key types for CA and certificate generation:

| Keyword     | Algorithm | Size/Curve | Notes            |
|-------------+-----------+------------+------------------|
| ~:ec-p256~  | EC        | P-256      | Default, fast    |
| ~:ec~       | EC        | P-256      | Alias            |
| ~:ec-p384~  | EC        | P-384      | Higher security  |
| ~:ec-p521~  | EC        | P-521      | Maximum security |
| ~:rsa-2048~ | RSA       | 2048 bits  | Compatibility    |
| ~:rsa~      | RSA       | 2048 bits  | Alias            |
| ~:rsa-4096~ | RSA       | 4096 bits  | Higher security  |

EC keys are recommended for new deployments. RSA keys are available for
compatibility with legacy systems.

* Serial Number Persistence

For production CAs, serial numbers must be persisted to avoid reuse:

#+begin_src janet
(import jsec/ca)

# Save before shutdown
(defn save-ca-state [ca path]
  (spit path (string (:get-serial ca))))

# Restore on startup
(defn load-ca [cert-path key-path serial-path]
  (def cert (slurp cert-path))
  (def key (slurp key-path))
  (def serial (scan-number (slurp serial-path)))
  (ca/create cert key {:serial serial}))
#+end_src

* Certificate Tracking

By default, CAs don't track issued certificates (memory efficient). Enable
tracking when you need to:
- List all issued certificates
- Implement revocation by certificate (not just serial)
- Audit certificate issuance

#+begin_src janet
# Enable tracking
(def ca (ca/generate {:track-issued true}))

# Issue some certificates
(:issue ca {:common-name "cert1"})
(:issue ca {:common-name "cert2"})

# Get all issued certs
(def issued (:get-issued ca))
(print (length issued))  # => 2
#+end_src

* Subject Alternative Names (SAN)

The ~:san~ option accepts an array of SAN entries:

#+begin_src janet
:san ["DNS:example.com"
      "DNS:www.example.com"
      "DNS:*.example.com"
      "IP:192.168.1.1"
      "IP:10.0.0.1"
      "email:admin@example.com"]
#+end_src

Prefix types:
| Prefix   | Description            |
|----------+------------------------|
| ~DNS:~   | DNS name (most common) |
| ~IP:~    | IP address             |
| ~email:~ | Email address          |
| ~URI:~   | Uniform Resource ID    |

* PKI Hierarchy Example

#+begin_src janet
(import jsec/ca)

# Root CA (offline, long-lived)
(def root (ca/generate {:common-name "Root CA"
                        :days-valid 7300     # 20 years
                        :organization "My Org"
                        :country "US"}))

# Intermediate CA (online, medium-lived)
(def intermediate (ca/generate-intermediate root
                    {:common-name "Intermediate CA"
                     :days-valid 1825        # 5 years
                     :path-length 0}))       # No sub-CAs

# Issue end-entity certificates from intermediate
(def server (:issue intermediate
              {:common-name "server.example.com"
               :san ["DNS:server.example.com"]
               :extended-key-usage "serverAuth"
               :days-valid 365}))

# Chain for server: server cert + intermediate cert
(def chain (string (server :cert) (:get-cert intermediate)))
#+end_src
